---
title: ğŸ§€ å¯¹std::sync::mpsc::Receiverä½¿ç”¨forå¾ªç¯
layout: post
author: cyven
tags: rust sender receiver for channel
categories: CS CS::Lang CS::Lang::Rust
---

è¿™æ˜¯ä¸€æ®µ ä»å¤šä¸ªproducer å‘é€å¤šä¸ªæ¶ˆæ¯çš„ä»£ç 

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;


pub fn test_thread(){
    let (tx,rx) =  mpsc::channel();
    let tx1 = tx.clone();

    thread::spawn(move ||{
        let val = vec![
            String::from("1:hi"),
            String::from("1:from"),
            String::from("1:spawn1"),
        ];
        for v in val{
            tx1.send(v).unwrap();
        }
    });
    thread::spawn(move ||{
        let val = vec![
            String::from("2:hello"),
            String::from("2:from"),
            String::from("2:spawn2"),
        ];
        for v in val{
            tx.send(v).unwrap();
        }

    });

    for receiver in rx{
        println!("get {}",receiver);
    }
}
```


## ä¸ºå•¥å¯ä»¥ for receiver in rx

åœ¨è¿™æ®µä»£ç é‡Œé¢ï¼Œä¸ºå•¥å¯ä»¥
```rust
for receiver in rx{
}
```
è¿™æ ·å»åš

å› ä¸ºä¸€èˆ¬ä¸éƒ½æ˜¯ `let receiver = rx.recv().unwrap();`

å› ä¸º `for in` å…¶å®èƒŒåçš„åŸç†æ˜¯è¿­ä»£å™¨

> The for in construct is able to interact with an Iterator in several ways. As discussed in the section on the Iterator trait, by default the for loop will apply the into_iter function to the collection.

æ‰€ä»¥åªè¦çœ‹ä¸€ä¸ªç»“æ„ä½“æœ‰æ²¡æœ‰`into_iter` å‡½æ•°å°±å¯ä»¥äº†

è€Œè¿™ä¸ª`into_iter` æ˜¯ å®šä¹‰åœ¨ `std::iter::IntoIterator`  ç‰¹æ€§ä¸­æ–¹æ³•

```rust
pub trait IntoIterator {
    type Item;
    type IntoIter: Iterator<Item = Self::Item>;

    // Required method
    fn into_iter(self) -> Self::IntoIter;
}
```

ä½œç”¨æ˜¯å°†è‡ªèº«è½¬åŒ–æˆä¸€ä¸ª è¿­ä»£å™¨ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„è¡Œä¸ºï¼Œéœ€è¦è¿”å›çš„ç±»å‹æ˜¯ `Iterator<T>`

è€Œä¸€èˆ¬çš„åšæ³•å¯ä»¥æ˜¯

```rust
impl<I: Iterator> IntoIterator for I {
    type Item = I::Item;
    type IntoIter = I;

    #[inline]
    fn into_iter(self) -> I {
        self
    }
}
```

ç„¶åè¿™æ—¶å€™éœ€è¦è‡ªèº«å®ç° `std::iter::Iterator` ç‰¹æ€§

ä¸»è¦æ˜¯å®ç° `fn next(&mut self) -> Option<Self::Item>;` è¿™ä¸ªæ–¹æ³•

è¿™æ ·å°±çŸ¥é“è¿­ä»£çš„ä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯ä»€ä¹ˆäº†

é‚£å…¶å® ä¸Šé¢çš„ `rx` æ˜¯ä¸€ä¸ª `std::sync::mpsc::Receiver` ç»“æ„ä½“ç±»å‹

è€Œå®ƒå®ç°äº† `IntoIterator` ç‰¹æ€§

![2024-05-02-11-39-02-screenshoot.png](../assets/img/2024-05-02-11-39-02-screenshoot.png)

```rust
#[stable(feature = "receiver_into_iter", since = "1.1.0")]
impl<T> IntoIterator for Receiver<T> {
    type Item = T;
    type IntoIter = IntoIter<T>;

    fn into_iter(self) -> IntoIter<T> {
        IntoIter { rx: self }
    }
}
```

åªä¸è¿‡è¿™é‡Œå®ƒå†…éƒ¨è‡ªå®šä¹‰äº†äº†ä¸€ä¸ª`IntoIter` ç»“æ„ä½“ï¼Œ

```rust
#[stable(feature = "receiver_into_iter", since = "1.1.0")]
#[derive(Debug)]
pub struct IntoIter<T> {
    rx: Receiver<T>,
}
```

ä¸åº”è¯¥æ˜¯è¿­ä»£å™¨å—ï¼Ÿ `type IntoIter: Iterator<Item = Self::Item>;` å› ä¸º`std::iter::IntoIterator`è¿™é‡Œæœ‰ä¸€ä¸ªç±»å‹çº¦æŸ

æ‰€ä»¥ä»–è¿™é‡Œè‡ªå®šä¹‰çš„ `IntoIter` å®ç°äº† `Iterator` ç‰¹æ€§

```rust
#[stable(feature = "receiver_into_iter", since = "1.1.0")]
impl<T> Iterator for IntoIter<T> {
    type Item = T;
    fn next(&mut self) -> Option<T> {
        self.rx.recv().ok()
    }
}
```

è‡ªæ­¤å®ç°äº†é—­ç¯

å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº† `self.rx.recv().ok()`


## é‚£è¿™ä¸ªforå¾ªç¯ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Ÿï¼Ÿ

è¿™ä¸ªé—®é¢˜æˆ‘é—®äº†ä¸€ä¸‹chatgpt

> å¾ªç¯åœ¨ä½•æ—¶ç»“æŸå–å†³äºå‘é€è€…å’Œæ¥æ”¶è€…çš„è¡Œä¸ºï¼š
>
> å½“å‘é€è€…å‘é€å®Œæ‰€æœ‰æ¶ˆæ¯åï¼Œå¹¶å…³é—­é€šé“ (tx åœ¨å¾ªç¯ç»“æŸåè¢«ä¸¢å¼ƒ)ï¼Œæ¥æ”¶è€… (rx) å°†ä¼šæ¥æ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯ï¼Œå¾ªç¯å°†éšä¹‹ç»“æŸã€‚
> å¦‚æœå‘é€è€…æå‰å…³é—­äº†é€šé“ï¼Œæˆ–è€…å‘é€è€… panicï¼Œæ¥æ”¶è€…å°†æ”¶åˆ°ä¸€ä¸ªç‰¹æ®Šçš„ä¿¡å·ï¼Œè¡¨æ˜é€šé“å·²ç»å…³é—­ï¼Œå¾ªç¯ä¹Ÿä¼šéšä¹‹ç»“æŸã€‚

å¤§æ¦‚çš„æ„æ€å°±æ˜¯å‘é€è€… `tx` `tx1`å•¥æ—¶å€™scopeç»“æŸåï¼Œé‚£ä¹ˆæ­¤æ—¶æ¥å—è€…å°±ä¼šçŸ¥é“

å› ä¸ºæœ¬æ¥ tx,rx åˆèµ·æ¥æ‰æ˜¯ä¸€ä¸ªæ•´ä½“

> A channel has two halves: a transmitter and a receiver.

ä½“ä¼šä¸€ä¸‹è¿™é‡Œhalvesçš„æ„æ€

æµ‹è¯•ä¸€ä¸‹
### è®©`tx1`å‘é€é—´éš”ä¹…ä¸€ç‚¹ï¼Œ`tx`å®Œæˆæ—©ä¸€ç‚¹

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;


pub fn test_thread(){
    let (tx,rx) =  mpsc::channel();
    let tx1 = tx.clone();

    thread::spawn(move ||{
        let val = vec![
            String::from("1:hi"),
            String::from("1:from"),
            String::from("1:spawn1"),
        ];
        for v in val{
            tx1.send(v).unwrap();
            thread::sleep(Duration::from_secs(2));//åŠ äº†è¿™å¥
        }
    });
    thread::spawn(move ||{
        let val = vec![
            String::from("2:hello"),
            String::from("2:from"),
            String::from("2:spawn2"),
        ];
        for v in val{
            tx.send(v).unwrap();
        }

    });

    for receiver in rx{
        println!("get {}",receiver);
    }
}
```

åœ¨ç¬¬ä¸€ä¸ªspawn threadä¸­çš„forå¾ªç¯å‘é€ä¸­å¢åŠ äº† `thread::sleep(Duration::from_secs(2))`

ä¸ºçš„æ˜¯èƒ½è®©ç¬¬äºŒä¸ª spawn threadæ—©ç‚¹ç»“æŸï¼Œé‚£è¿™æ—¶å€™çœ‹rxä¼šä¸ä¼šææ—©é€€å‡º

![2024-05-02-12-15-10-screenshoot.png](../assets/img/2024-05-02-12-15-10-screenshoot.png)

ä¸ä¼šï¼Œåé¢ä¸¤ä¸ªå„ç­‰äº†2ç§’æ‰“å°å‡ºæ¥

### è®©å…¶ä¸­ä¸€ä¸ªå…ˆå‘é€å®Œï¼Œå¦ä¸€ä¸ªå†å¼€å§‹å‘é€

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;


pub fn test_thread(){
    let (tx,rx) =  mpsc::channel();
    let tx1 = tx.clone();

    thread::spawn(move ||{
        let val = vec![
            String::from("1:hi"),
            String::from("1:from"),
            String::from("1:spawn1"),
        ];
        thread::sleep(Duration::from_secs(5));//ç§»åˆ°è¿™é‡Œ
        for v in val{
            tx1.send(v).unwrap();
            //thread::sleep(Duration::from_secs(2));//æ³¨é‡Šæ‰
        }
    });
    thread::spawn(move ||{
        let val = vec![
            String::from("2:hello"),
            String::from("2:from"),
            String::from("2:spawn2"),
        ];
        for v in val{
            tx.send(v).unwrap();
        }

    });

    for receiver in rx{
        println!("get {}",receiver);
    }
}
```

åœ¨ç¬¬ä¸€ä¸ª spawn thread å¼€å§‹forå¾ªç¯å‘é€å‰ï¼Œè¿›è¡Œä¼‘çœ ï¼Œæ„Ÿè§‰5ç§’è¶³å¤Ÿäº†

ä¸ºçš„å°±æ˜¯è®©ç¬¬äºŒä¸ª spawn thread æ—©ç‚¹å®Œæˆï¼Œçœ‹çœ‹rxä¼šä¸ä¼šç»“æŸ

![2024-05-02-12-18-10-screenshoot.png](../assets/img/2024-05-02-12-18-10-screenshoot.png)

ä¹Ÿä¸ä¼š

æˆ‘çŒœæµ‹è¿™é‡Œå¯ä»¥æ˜¯ `tx.clone()` è¿™é‡Œèµ·ä½œç”¨ï¼Œrxä»ä¸€å¼€å§‹å°±çŸ¥é“æœ‰ä¸¤ä¸ªå‘é€è€…ï¼Œåªæœ‰æ‰€æœ‰çš„å‘é€è€…éƒ½ å—å±äº†ï¼Œå®ƒæ‰å®‰å¿ƒçš„èµ°
